#### 一、概述

1. 重新换了一个6.18的内核 开启了 Transparent Hugepae Support选项 
2. 完善了我之前没做完的挂载脚本，实现一键解密，挂载等操作
3. 测试了一下xfs和ext4性能，比之前i3测试机器的数据有所提升，在xfs与ext4的对比中 xfs在sm4顺序读的的速率明显高于ext4

#### 二、下一步计划

1. 验证xfs是否采用了hugepages，查看hugepages-64kB的分配情况
2. 测试一些其他数据

#### 三、一些疑问

1. 是否使用large-folio和格式化磁盘的参数有没有关系
2. 怎么验证是否具体使用了large-folio，可以追踪有没有调用do_huge_pmd_anonymous_page这个函数吗

#### 四、测试数据

目前的测试命令 

````bash
# 检查thp
cat /sys/kernel/mm/transparent_hugepage/enabled
[always] madvise never

# 检查支持的hugespage 大小
uos@uos-PC:~$ ls  /sys/kernel/mm/transparent_hugepage/hugepages-*
/sys/kernel/mm/transparent_hugepage/hugepages-1024kB:
enabled  shmem_enabled  stats

/sys/kernel/mm/transparent_hugepage/hugepages-128kB:
enabled  shmem_enabled  stats

/sys/kernel/mm/transparent_hugepage/hugepages-16kB:
enabled  shmem_enabled  stats

/sys/kernel/mm/transparent_hugepage/hugepages-2048kB:
enabled  shmem_enabled  stats

/sys/kernel/mm/transparent_hugepage/hugepages-256kB:
enabled  shmem_enabled  stats

/sys/kernel/mm/transparent_hugepage/hugepages-32kB:
enabled  shmem_enabled  stats

/sys/kernel/mm/transparent_hugepage/hugepages-512kB:
enabled  shmem_enabled  stats

/sys/kernel/mm/transparent_hugepage/hugepages-64kB:
enabled  shmem_enabled  stats

/sys/kernel/mm/transparent_hugepage/hugepages-8kB:
shmem_enabled  stats

# 检查page是否开启
uos@uos-PC:~$ cat /sys/kernel/mm/transparent_hugepage/hugepages-*/enabled 
always inherit madvise [never]
always inherit madvise [never]
always inherit madvise [never]
always [inherit] madvise never
always inherit madvise [never]
always inherit madvise [never]
always inherit madvise [never]
always inherit madvise [never]

# 经检查 只有 2048k 的是开启的

# 开启
sudo echo 3 > /sys/kernel/mm/transparent_hugepage/hugepages-*/enabled 

# 检查hugepage分配情况
uos@uos-PC:~$ grep "AnonHugePages" /proc/meminfo
AnonHugePages:    167936 kB


# 格式化xfs
sudo mkfs.xfs -f -b size=64k -l size=256m /dev/mapper/sm4_disk
sudo mkfs.xfs -f -b size=64k -l size=256m /dev/mapper/aes_disk
sudo mkfs.xfs -f -b size=64k -l size=256m /dev/nvme0n1p5

# 格式化ext4
mkfs.ext4 /dev/nvme0n1p5
mkfs.ext4 /dev/mapper/aes_disk
mkfs.ext4 /dev/mapper/sm4_disk

# 挂载命令
mount -o noatime,nodiratime,allocsize=64m,largeio,inode64 /dev/nvme0n1p5 /mnt/fio_test/nor_fs
mount -o noatime,nodiratime,allocsize=64m,largeio,inode64 /dev/mapper/aes_disk /mnt/fio_test/aes_fs
mount -o noatime,nodiratime,allocsize=64m,largeio,inode64 /dev/mapper/sm4_disk /mnt/fio_test/sm4_fs
````

###### 今天测试的数据

![image-20251217184734371](/home/tianjiao/.config/Typora/typora-user-images/image-20251217184734371.png)

###### 之前的数据

![image-20251217184716010](/home/tianjiao/.config/Typora/typora-user-images/image-20251217184716010.png)