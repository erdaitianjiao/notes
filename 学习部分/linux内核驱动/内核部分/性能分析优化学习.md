### 性能分析以及调优

#### 一、总览

性能指标
![imag](img/系统资源出发性能指标.jpg)

性能分析总览
![imag](img/linux_perf_tools_full.png)

性能优化思维导图
![imag](img/性能分析思维导图.jpg)

#### 二、cpu篇

##### 1. 性能分析指标
###### **1) cpu平均负载**

- 系统处于可运行状态和不可中断状态的平均进程数，也就是平均活跃进程数，它和CPU使用率并没有直接关系

> - 所谓可运行状态的进程，是指正在使用CPU或者正在等待CPU的进程，也就是我们常用ps命令看到的，处于R状态（Running 或 Runnable）的进程。
>
> - 不可中断状态的进程则是正处于内核态关键流程中的进程，并且这些流程是不可打断的，比如最常见的是等待硬件设备的I/O响应，也就是我们在ps命令中看到的D状态（Uninterruptible Sleep，也称为Disk Sleep）的进程
>
> 平均负载是指单位时间内，处于可运行状态和不可中断状态的进程数。所以，它不仅包括了正在使用 CPU 的进程，还包括等待 CPU 和等待 I/O 的进程

###### **2) cpu使用率**

- 单位时间内 CPU 繁忙情况的统计

**两者区别**

> 1. CPU 使用率，是单位时间内 CPU 繁忙情况的统计，跟平均负载并不一定完全对应。比如：
>
> 2. CPU 密集型进程，使用大量 CPU 会导致平均负载升高，此时这两者是一致的；
>
> 3. I/O 密集型进程，等待 I/O 也会导致平均负载升高，但 CPU 使用率不一定很高；
>
> 4. 大量等待 CPU 的进程调度也会导致平均负载升高，此时的CPU使用率也会比较高。

###### **3) cpu上下文切换**

- CPU 上下文切换，就是先把前一个任务的 CPU 上下文（也就是 CPU 寄存器和程序计数器）保存起来，然后加载新任务的上下文到这些寄存器和程序计数器，最后再跳转到程序计数器所指的新位置，运行新任务

 **CPU 上下文**：CPU 寄存器，程序计数器存储指令位置。它们都是 CPU 在运行任务前必须的依赖环境

**分类**

1. **进程上下文切换**

   - 进程上下文切换，是指从一个进程切换到另一个进程运行
   - 而系统调用过程中一直是同一个进程在运行

   系统调用过程通常称为特权模式切换，而不是上下文切换，但是在系统调用过程中是肯定会发生CPU上下文切换的

   ![image](img/进程上下文切换.jpg)

2. **线程上下文切换**

   - 线程是调度的基本单位，而进程则是资源拥有的基本单位

     >- 当进程只有一个线程时，可以认为进程就等于线程。
     >- 当进程拥有多个线程时，这些线程会共享相同的虚拟内存和全局变量等资源。这些资源在上下文切换时是不需要修改的。
     >- 另外，线程也有自己的私有数据，比如栈和寄存器等，这些在上下文切换时也是需要保存的。

3. **中断上下文切换**
   - 中断处理会打断进程的正常调度和执行
   - 对同一个 CPU 来说，中断处理比进程拥有更高的优先级



##### 2. 一些命令的解释

###### 1) uptime

```
02:34:03 up 2 days, 20:14,  1 user,  load average: 0.63, 0.83, 0.88
```

02:34:03               		  当前时间
up 2 days, 20:14       	系统运行时间
1 user                 			登录用户数

 后三个数字，依次则是过去1分钟、5分钟、15分钟的平均负载（Load Average）

###### 2) stress systembench

```bash
# stress 是一个 Linux 系统压力测试工具
# systembench 也是
```

###### 3) sysstat

```bash
# 包含了常用的 Linux 性能工具，用来监控和分析系统的性能 其中的命令如 mpstat 和 pidstat iostat
```

###### 4) mpstat 

```bash
mpstat -P ALL 1 # 查看cpu负载信息
mpstat -P ALL 5
05:50:31 PM  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
05:50:36 PM  all    2.24    0.00    2.17    0.03    0.00    0.00    0.00    0.00    0.00   95.56
05:50:36 PM    0    2.05    0.00    1.84    0.00    0.00    0.00    0.00    0.00    0.00   96.11
05:50:36 PM    1    2.05    0.00    2.05    0.00    0.00    0.00    0.00    0.00    0.00   95.90
05:50:36 PM    2    2.25    0.00    2.25    0.00    0.00    0.00    0.00    0.00    0.00   95.50
05:50:36 PM    3    2.42    0.00    2.83    0.00    0.00    0.00    0.00    0.00    0.00   94.75
05:50:36 PM    4    2.65    0.00    2.24    0.00    0.00    0.00    0.00    0.00    0.00   95.10
05:50:36 PM    5    2.44    0.00    2.24    0.00    0.00    0.00    0.00    0.00    0.00   95.32
05:50:36 PM    6    2.44    0.00    2.24    0.20    0.00    0.00    0.00    0.00    0.00   95.11
05:50:36 PM    7    1.64    0.00    1.64    0.00    0.00    0.00    0.00    0.00    0.00   96.72

```

###### 5) pidstat 

```bash
pidstat -u 5 	# 查看进程占用信息
05:48:31 PM   UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command
05:48:36 PM     0       706    0.20    0.00    0.00    0.00    0.20     0  kteamsvc
05:48:36 PM     0       708    0.20    0.00    0.00    0.00    0.20     4  kcore   

pidstat -w 4
Linux 6.12.43-amd64-desktop-rolling (erdai)     01/13/2026      _x86_64_        (8 CPU)

05:54:01 PM   UID       PID   cswch/s nvcswch/s  Command
05:54:05 PM     0         1      0.25      0.00  systemd
05:54:05 PM     0        17      5.47      0.00  ksoftirqd/0                                                 05:54:05 PM     0        18     26.87      0.00  rcu_preempt                                                 05:54:05 PM     0        22      0.25      0.00  migration/0                                                 
```

>一个是 cswch ，表示每秒自愿上下文切换（voluntary context switches）的次数
>
>另一个则是 nvcswch ，表示每秒非自愿上下文切换（non voluntary context switches）的次数
>
>- 所谓**自愿上下文切换，是指进程无法获取所需资源，导致的上下文切换**。比如说， I/O、内存等系统资源不足时，就会发生自愿上下文切换。
>- 而**非自愿上下文切换，则是指进程由于时间片已到等原因，被系统强制调度，进而发生的上下文切换**。比如说，大量进程都在争抢 CPU 时，就容易发生非自愿上下文切换。

###### 6) vmstat

```bash
vmstat 5
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 0  0      0 7005360  91564 818900    0    0     0     0   25   33  0  0 100  0  0
```

>- cs（context switch）是每秒上下文切换的次数
>- in（interrupt）则是每秒中断的次数
>- r（Running or Runnable）是就绪队列的长度，也就是正在运行和等待CPU的进程数
>- b（Blocked）则是处于不可中断睡眠状态的进程数

###### 7) cat /proc/interrupts

```bash
watch -d cat /proc/interrupts
# 可以查看各个cpu中断发生的次数和类型
```

